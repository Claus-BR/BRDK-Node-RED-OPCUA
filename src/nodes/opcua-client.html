<!--
  @file opcua-client.html
  @description Editor definition for the OPC UA Client node.

  The main workhorse: supports 20 actions for interacting with OPC UA servers.

  Outputs:
    [0] Data results
    [1] Status & error notifications
    [2] Batch results (read)
-->

<!-- ═══════════════════════════════════════════════════════════════════════════
     1. NODE REGISTRATION
     ═══════════════════════════════════════════════════════════════════════ -->
<script type="text/javascript">
  RED.nodes.registerType("opcua-client", {
    category: "BRDK OPCUA",
    color: "#3FADB5",
    defaults: {
      endpoint:         { value: "", type: "opcua-endpoint", required: true },
      action:           { value: "read", required: true },
      deadbandtype:     { value: "a" },
      deadbandvalue:    { value: 1 },
      time:             { value: 10 },
      timeUnit:         { value: "s" },
      name:             { value: "" },
      // Transport settings
      useTransport:     { value: false },
      maxChunkCount:    { value: 1 },
      maxMessageSize:   { value: 8192 },
      receiveBufferSize: { value: 8192 },
      sendBufferSize:   { value: 8192 },
      // Session settings
      keepSessionAlive: { value: false },
      connectOnStart:   { value: true },
      // Client identity
      applicationName:  { value: "" },
      applicationUri:   { value: "" },
    },
    inputs: 1,
    outputs: 3,
    icon: "font-awesome/fa-cogs",
    label: function () {
      return this.name || "opcua client";
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    paletteLabel: "opcua client",
    outputLabels: ["data", "status", "batch"],

    oneditprepare: function () {
      var node = this;

      function updateVisibility() {
        var action = $("#node-input-action").val();
        var showInterval = ["subscribe", "events", "monitor"].includes(action);
        var showDeadband = action === "monitor";
        var showTransport = $("#node-input-useTransport").prop("checked");

        $(".interval-row").toggle(showInterval);
        $(".deadband-row").toggle(showDeadband);
        $(".transport-row").toggle(showTransport);
      }

      $("#node-input-action").on("change", updateVisibility);
      $("#node-input-useTransport").on("change", updateVisibility);

      updateVisibility();
    },
  });
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════
     2. EDIT TEMPLATE
     ═══════════════════════════════════════════════════════════════════════ -->
<script type="text/html" data-template-name="opcua-client">

  <!-- Endpoint -->
  <div class="form-row">
    <label for="node-input-endpoint"><i class="fa fa-globe"></i> Endpoint</label>
    <input type="text" id="node-input-endpoint">
  </div>

  <!-- Action -->
  <div class="form-row">
    <label for="node-input-action"><i class="fa fa-bolt"></i> Action</label>
    <select id="node-input-action">
      <optgroup label="Data Access">
        <option value="read">Read</option>
        <option value="write">Write</option>
      </optgroup>
      <optgroup label="Subscriptions">
        <option value="subscribe">Subscribe</option>
        <option value="monitor">Monitor (Deadband)</option>
        <option value="unsubscribe">Unsubscribe</option>
        <option value="deletesubscription">Delete Subscription</option>
      </optgroup>
      <optgroup label="Browsing">
        <option value="browse">Browse</option>
        <option value="info">Info (All Attributes)</option>
      </optgroup>
      <optgroup label="Events">
        <option value="events">Events</option>
        <option value="acknowledge">Acknowledge</option>
      </optgroup>
      <optgroup label="Methods">
        <option value="method">Call Method</option>
      </optgroup>
      <optgroup label="History">
        <option value="history">History Read</option>
      </optgroup>
      <optgroup label="File Transfer">
        <option value="readfile">Read File</option>
        <option value="writefile">Write File</option>
      </optgroup>
      <optgroup label="Advanced">
        <option value="build">Build ExtensionObject</option>
        <option value="register">Register Nodes</option>
        <option value="unregister">Unregister Nodes</option>
      </optgroup>
      <optgroup label="Connection">
        <option value="connect">Connect</option>
        <option value="disconnect">Disconnect</option>
        <option value="reconnect">Reconnect</option>
      </optgroup>
    </select>
  </div>

  <!-- Interval (for subscribe/events/monitor) -->
  <div class="form-row interval-row" style="display: none;">
    <label for="node-input-time"><i class="fa fa-clock-o"></i> Interval</label>
    <input type="number" id="node-input-time" style="width: 80px;" min="1">
    <select id="node-input-timeUnit" style="width: 100px;">
      <option value="ms">milliseconds</option>
      <option value="s">seconds</option>
      <option value="m">minutes</option>
      <option value="h">hours</option>
    </select>
  </div>

  <!-- Deadband (for monitor only) -->
  <div class="form-row deadband-row" style="display: none;">
    <label for="node-input-deadbandtype"><i class="fa fa-filter"></i> Deadband</label>
    <select id="node-input-deadbandtype" style="width: 100px;">
      <option value="a">Absolute</option>
      <option value="p">Percent</option>
    </select>
    <input type="number" id="node-input-deadbandvalue" style="width: 80px;" step="0.1" min="0">
  </div>

  <hr>

  <!-- Session settings -->
  <div class="form-row">
    <label style="width: auto;">
      <input type="checkbox" id="node-input-connectOnStart" style="width: auto;">
      Connect on start
    </label>
  </div>
  <div class="form-row">
    <label style="width: auto;">
      <input type="checkbox" id="node-input-keepSessionAlive" style="width: auto;">
      Keep session alive
    </label>
  </div>

  <!-- Transport settings toggle -->
  <div class="form-row">
    <label style="width: auto;">
      <input type="checkbox" id="node-input-useTransport" style="width: auto;">
      Custom transport settings
    </label>
  </div>

  <!-- Transport settings (shown when checkbox is checked) -->
  <div class="form-row transport-row" style="display: none;">
    <label for="node-input-maxChunkCount">Max Chunk Count</label>
    <input type="number" id="node-input-maxChunkCount" min="1">
  </div>
  <div class="form-row transport-row" style="display: none;">
    <label for="node-input-maxMessageSize">Max Message Size</label>
    <input type="number" id="node-input-maxMessageSize" min="1024">
  </div>
  <div class="form-row transport-row" style="display: none;">
    <label for="node-input-receiveBufferSize">Receive Buffer</label>
    <input type="number" id="node-input-receiveBufferSize" min="1024">
  </div>
  <div class="form-row transport-row" style="display: none;">
    <label for="node-input-sendBufferSize">Send Buffer</label>
    <input type="number" id="node-input-sendBufferSize" min="1024">
  </div>

  <hr>

  <!-- Client identity -->
  <div class="form-row">
    <label for="node-input-applicationName"><i class="fa fa-id-card"></i> App Name</label>
    <input type="text" id="node-input-applicationName" placeholder="BRDK-NodeRED-OPCUA-Client">
  </div>
  <div class="form-row">
    <label for="node-input-applicationUri"><i class="fa fa-link"></i> App URI</label>
    <input type="text" id="node-input-applicationUri" placeholder="(auto-generated)">
  </div>

  <!-- Node name -->
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

</script>

<!-- ═══════════════════════════════════════════════════════════════════════════
     3. HELP TEXT
     ═══════════════════════════════════════════════════════════════════════ -->
<script type="text/html" data-help-name="opcua-client">
  <p>Connects to an OPC UA server and performs read, write, subscribe, browse, method call, and other operations.</p>

  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt class="optional">action <span class="property-type">string</span></dt>
    <dd>Override the node's configured action at runtime. One of:
    <code>read</code>, <code>write</code>, <code>subscribe</code>, <code>monitor</code>,
    <code>unsubscribe</code>, <code>deletesubscription</code>, <code>browse</code>,
    <code>events</code>, <code>info</code>, <code>build</code>,
    <code>register</code>, <code>unregister</code>,
    <code>acknowledge</code>, <code>history</code>, <code>readfile</code>,
    <code>writefile</code>, <code>connect</code>, <code>disconnect</code>,
    <code>reconnect</code>, <code>method</code>.</dd>

    <dt>topic <span class="property-type">string</span></dt>
    <dd>The OPC UA NodeId to operate on (e.g. <code>ns=2;s=Temperature</code>).</dd>

    <dt class="optional">payload <span class="property-type">any</span></dt>
    <dd>The value for write operations, or an array of items for batch operations.</dd>

    <dt class="optional">datatype <span class="property-type">string</span></dt>
    <dd>OPC UA data type name for write operations (e.g. <code>Double</code>).</dd>
  </dl>

  <h3>Outputs</h3>
  <ol class="node-ports">
    <li>Data
      <dl class="message-properties">
        <dt>payload <span class="property-type">any</span></dt>
        <dd>Read value, write status code, browse results, event data, or method output.</dd>
        <dt class="optional">statusCode <span class="property-type">object</span></dt>
        <dd>OPC UA StatusCode for the operation.</dd>
        <dt class="optional">serverTimestamp <span class="property-type">Date</span></dt>
        <dd>Server timestamp of the value.</dd>
        <dt class="optional">sourceTimestamp <span class="property-type">Date</span></dt>
        <dd>Source timestamp of the value.</dd>
      </dl>
    </li>
    <li>Status
      <dl class="message-properties">
        <dt>status <span class="property-type">string</span></dt>
        <dd>Current node status (e.g. "connected", "reading", "error").</dd>
        <dt>endpoint <span class="property-type">string</span></dt>
        <dd>The OPC UA server endpoint URL.</dd>
        <dt>error <span class="property-type">string | null</span></dt>
        <dd>Error description (null when no error).</dd>
      </dl>
    </li>
    <li>Batch
      <dl class="message-properties">
        <dt>payload <span class="property-type">array</span></dt>
        <dd>All values from a read operation.</dd>
        <dt>items <span class="property-type">array</span></dt>
        <dd>The items that were read.</dd>
      </dl>
    </li>
  </ol>

  <h3>Details</h3>
  <p>This node connects to an OPC UA server (configured via the Endpoint config node)
  and performs the selected action. The action can be set in the node configuration or
  overridden per-message via <code>msg.action</code>.</p>

  <h4>Data Access</h4>
  <ul>
    <li><b>Read</b> — reads the values of nodes specified in <code>msg.items</code>. Sends per-item results on output 1 and batch results on output 3.</li>
    <li><b>Write</b> — writes values from <code>msg.items</code> (each item must have a <code>value</code> property). Requires <code>datatype</code> on each item.</li>
  </ul>

  <h4>Subscriptions</h4>
  <ul>
    <li><b>Subscribe</b> — monitors value changes for all items in <code>msg.items</code>. Single items use individual monitoring; multiple items use a group subscription.</li>
    <li><b>Monitor</b> — like subscribe but with deadband filtering.</li>
    <li><b>Unsubscribe</b> — stops monitoring items in <code>msg.items</code>.</li>
    <li><b>Delete Subscription</b> — removes the entire subscription.</li>
  </ul>

  <h4>History</h4>
  <p>Set <code>msg.aggregate</code> to <code>"raw"</code>, <code>"min"</code>, <code>"max"</code>, <code>"ave"</code>, or <code>"interpolative"</code>.
  Use <code>msg.start</code> and <code>msg.end</code> for the time range.</p>

  <h4>Methods</h4>
  <p>Set <code>msg.objectId</code>, <code>msg.methodId</code>, and <code>msg.inputArguments</code> (array of <code>{dataType, value}</code>).</p>

  <h4>Events</h4>
  <p>Subscribes to OPC UA events. Set <code>msg.eventTypeIds</code> for the event type filter.</p>

  <h4>Connection</h4>
  <p>Use <code>connect</code>, <code>disconnect</code>, or <code>reconnect</code> actions to dynamically control the connection.
  Set <code>msg.OpcUaEndpoint</code> with new endpoint details for dynamic connect.</p>

  <p><b>Connect on start</b>: When checked (default), the node connects to the server as soon as the flow
  starts. When unchecked, the node remains idle until the first message arrives or an explicit
  <code>connect</code> action is received. This is useful for subflows with dynamic endpoints.</p>

  <h3>References</h3>
  <ul>
    <li><a href="https://node-opcua.github.io/">node-opcua documentation</a></li>
    <li><a href="https://reference.opcfoundation.org/">OPC UA specification</a></li>
  </ul>
</script>
